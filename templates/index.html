<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning des rendez-vous</title>
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<body class="dark-mode">
    <!-- Entête -->
    {% include 'header.html' %}
    <div class="container">
        <h1 class="text-center my-5">Planning des rendez-vous</h1>
        <!-- Tableau -->
        <div class="row">
            <div class="col">
                <table class="table table-bordered text-center">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col" onclick="sortTable(0)">Médecin <button class="sort-btn"><i class="fa fa-sort"></i></button></th>
                            <th scope="col" onclick="sortTable(1)">Civilité <button class="sort-btn"><i class="fa fa-sort"></i></button></th>
                            <th scope="col" onclick="sortTable(2)">Nom <button class="sort-btn"><i class="fa fa-sort"></i></button></th>
                            <th scope="col" onclick="sortTable(3)">Prénom <button class="sort-btn"><i class="fa fa-sort"></i></button></th>
                            <th scope="col" onclick="sortTable(4)">Sexe <button class="sort-btn"><i class="fa fa-sort"></i></button></th>
                            <th scope="col" onclick="sortTable(5)">Date de naissance <button class="sort-btn"><i class="fa fa-sort"></i></button></th>
                            <th scope="col" onclick="sortTable(6)">Age <button class="sort-btn"><i class="fa fa-sort"></i></button></th></th> 
                            <th scope="col" onclick="sortTable(7)">Téléphone <button class="sort-btn"><i class="fa fa-sort"></i></button></th></th> 
                            <th scope="col" onclick="sortTable(8)">Date du rendez-vous <button class="sort-btn"><i class="fa fa-sort"></i></button></th>
                            <th scope="col" onclick="sortTable(9)">Heure <button class="sort-btn"><i class="fa fa-sort"></i></button></th>
                            <th scope="col" onclick="sortTable(10)">Statut <button class="sort-btn"><i class="fa fa-sort"></i></button></th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appointment in appointments %}
                        <tr {% if appointment.appointment_time < now %} class="appointment-passed" {% endif %}>
                            <td>{{ appointment.health_professional_name }}</td>
                            <td>{{ appointment.patient.prefix }}</td>
                            <td>{{ appointment.patient.name }}</td>
                            <td>{{ appointment.patient.first_name }}</td>
                            <td>{{ appointment.patient.sex[0] }}</td>
                            <td>{{ appointment.patient.date_of_birth }}</td>
                            <td>{{ appointment.patient.tel }}</td>
                            <!-- Modifier la cellule de date pour ajouter une classe ou un attribut de données -->
                            <td class="appointment-date" data-date="{{ appointment.appointment_time }}">
                                {{ appointment.appointment_time.strftime('%d-%m-%Y') }}
                            </td>
                            <td>{{ appointment.appointment_time.strftime('%H:%M') }}</td>
                            <td>
                                <select onchange="changeStatus('{{ appointment.id }}', this.value)">
                                    <option value="A venir" {% if appointment.status=='A venir' %} selected {% endif %}>A venir</option>
                                    <option value="Absent non-excusé" {% if appointment.status=='Absent non-excusé' %} selected {% endif %}>Absent
                                        non-excusé</option>
                                    <option value="Absent excusé" {% if appointment.status=='Absent excusé' %} selected {% endif %}>Absent excusé
                                    </option>
                                    <option value="Vu" {% if appointment.status=='Vu' %} selected {% endif %}>Vu</option>
                                     <option value="En salle d'attente" {% if appointment.status=='En salle d\' attente' %} selected {% endif %}>En salle d'attente</option>
                                </select>
                            </td>
                            <td>
                                {% if appointment.appointment_time < now %} <i class="fa fa-flag" style="color: red;"></i> Rendez-vous dépassée
                                    {% else %} <!-- Ajouter un bouton de suppression pour les rendez-vous à venir -->
                                    <!-- Bouton Supprimer avec bulle d'aide -->
                                    <!-- Bouton Supprimer Rendez-vous avec bulle d'aide -->
                                    <button class="delete-appointment-button"
                                        onclick="deleteAppointment('{{ appointment.id }}', '{{ appointment.patient.name }}', '{{ appointment.appointment_time }}')"
                                        title="Supprimer le rendez-vous">
                                        <i class="fa fa-trash"></i>
                                        <span class="tooltip">Supprimer</span> <!-- Bulle d'aide -->
                                    </button>
                                    
                                    <!-- Bouton Déplacer Rendez-vous avec bulle d'aide -->
                                    <button class="move-appointment-button" onclick="moveAppointment('{{ appointment.id }}')"
                                        title="Déplacer le rendez-vous">
                                        <span class="icon"></span>
                                        <span class="tooltip">Déplacer</span> <!-- Bulle d'aide -->
                                    </button>
                                    {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Pagination -->
        <div class="row">
            <div class="col">
                <div class="pagination">
                    <label for="items-per-page">Elements par page :</label>
                    <select id="items-per-page">
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="500">500</option>
                    </select>
                    <span id="page-info">
                        {% if appointments|length > 0 %}
                            {% set start_index = (appointments|length > 0) and ((1 - 1) * 50 + 1) or 0 %}
                            {% set end_index = (appointments|length > 0) and (1 * 50) or 0 %}
                            {{ start_index }} - {{ end_index }} sur {{ total_appointments }}
                        {% else %}
                            0 - 0 sur 0
                        {% endif %}
                    </span>
                    <button class="prev-page">&lt;</button>
                    <button class="next-page">&gt;</button>
                </div>
            </div>
        </div>
    </div>
    <div id="last-refresh"></div>
    <script> const totalAppointments = "{{ total_appointments }}"; </script>
    <!-- Script JS pour la pagination -->
    <script src="{{ url_for('static', filename='pagination.js') }}"></script>
    <!-- Inclusion du fichier JavaScript externe -->
    <script src="{{ url_for('static', filename='sort.js') }}"></script>
    <!-- Script JS pour la pagination -->
    <script src="{{ url_for('static', filename='moment.js') }}"></script>
    <script>
     function deleteAppointment(appointmentId, patientName, appointmentDate) {
        // Construit le message de confirmation avec les informations du rendez-vous
        const confirmationMessage = `Confirmez-vous la suppression du rendez-vous pour ${patientName} le ${appointmentDate} ?`;

        // Demande une confirmation avant de supprimer le rendez-vous
        if (confirm(confirmationMessage)) {
            // Envoie une requÃªte DELETE A  l'API pour supprimer le rendez-vous avec l'ID spécifié
            fetch(`/appointments/${appointmentId}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (response.ok) {
                        // Recharge la page aprÃšs la suppression
                        window.location.reload();
                    } else if (response.status === 403) {
                        // Affiche un message d'erreur si la suppression est refusée
                        alert('Impossible de supprimer le rendez-vous. Le délai de suppression est écoulé.');
                    } else {
                        // GÃšre les autres erreurs de suppression
                        console.error('Erreur lors de la suppression du rendez-vous');
                    }
                })
                .catch(error => console.error('Erreur rÃ©seau :', error));
            }
        }
    </script>
    <script>
        function changeStatus(appointmentId, newStatus) {
            // Envoie une requête PATCH à l'API pour mettre à jour le statut du rendez-vous avec l'ID spécifié
            fetch(`/update-appointment-status/${appointmentId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newStatus })
            })
                .then(response => {
                    if (response.ok) {
                        // Recharge la page après la mise à jour
                        window.location.reload();
                    } else {
                        console.error('Erreur lors de la mise à jour du statut du rendez-vous');
                    }
                })
                .catch(error => console.error('Erreur réseau :', error));
        }
    </script>
    <script>
        function showCalendar(date) {
            // Vous pouvez implémenter ici la logique pour afficher un calendrier avec la date passée en paramétre
            // Par exemple, vous pouvez utiliser une bibliothéque JavaScript comme FullCalendar.js pour afficher un calendrier interactif
            alert('Afficher le calendrier pour la date : ' + date);
        }
    </script>
    <script>
    // Fonction pour rafraîchir automatiquement la page à intervalles réguliers
    function autoRefresh() {
    // Définir l'intervalle de rafraîchissement en millisecondes (par exemple, 5 minutes)
    const refreshInterval = 60 * 1000; // 5 minutes
    setInterval(function() {
    // Recharger la page
    location.reload();
    }, refreshInterval);
    }
    // Appeler la fonction autoRefresh pour démarrer le rafraîchissement automatique
    autoRefresh();
    </script>
    <script>// Fonction pour mettre à jour la date du dernier rafraîchissement
        function updateLastRefresh() {
            const lastRefreshElement = document.getElementById('last-refresh');
            const currentDate = new Date();
            lastRefreshElement.textContent = `Dernier rafraîchissement : ${currentDate.toLocaleString()}`;
        }

        // Mettre à jour la date du dernier rafraîchissement lorsque la page est chargée
        updateLastRefresh();

        // Ensuite, à chaque rafraîchissement de la page, appelez également la fonction updateLastRefresh()
        window.addEventListener('load', function () {
            setInterval(updateLastRefresh, refreshInterval);
        });
    </script>
    <script>
       // Fonction pour calculer l'âge à partir de la date de naissance
        function calculateAge(dateOfBirth) {
            // Vérifier si la date de naissance est valide
            const dobParts = dateOfBirth.split('-');
            const dobDay = parseInt(dobParts[0]);
            const dobMonth = parseInt(dobParts[1]) - 1; // Mois est 0-indexé dans JavaScript
            const dobYear = parseInt(dobParts[2]);

            // Si la date est invalide, retourner NaN
            if (isNaN(dobDay) || isNaN(dobMonth) || isNaN(dobYear)) {
                return NaN;
            }

            const today = new Date();
            const birthDate = new Date(dobYear, dobMonth, dobDay);
            let age = today.getFullYear() - birthDate.getFullYear();
            const month = today.getMonth() - birthDate.getMonth();
            if (month < 0 || (month === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        // Parcourez les lignes du tableau pour calculer et afficher l'âge de chaque patient
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const dateOfBirth = row.cells[5].textContent; // Récupérer la date de naissance du patient depuis la cellule correspondante
            const age = calculateAge(dateOfBirth); // Calculer l'âge à partir de la date de naissance
            const ageCell = document.createElement('td'); // Créer une nouvelle cellule pour afficher l'âge

            // Vérifier si l'âge est NaN (indiquant une date de naissance invalide) et afficher un message d'erreur si nécessaire
            if (isNaN(age)) {
                ageCell.textContent = 'Date de naissance invalide';
            } else {
                ageCell.textContent = age; // Ajouter l'âge calculé dans la cellule
            }

            // Insérer la cellule d'âge après la cellule de la date de naissance
            row.cells[5].insertAdjacentElement('afterend', ageCell);
        });
    </script>
  <script>
    function moveAppointment(appointmentId) {
        // Demander à l'utilisateur de saisir la nouvelle date et heure pour le rendez-vous
        const newPlanning = prompt("Entrez la nouvelle date et heure pour le rendez-vous avec l'ID " + appointmentId + " (Format : JJ-MM-AAAA HH:MM):");
        if (newPlanning != null && newPlanning.trim() !== "") {
            // Valider le format de la date et de l'heure
            const dateRegex = /^\d{2}-\d{2}-\d{4} \d{2}:\d{2}$/;
            if (!dateRegex.test(newPlanning)) {
                alert("Format de date et heure invalide. Veuillez saisir au format JJ-MM-AAAA HH:MM");
                return;
            }

            // Envoyer une requête PATCH à l'API pour déplacer le rendez-vous vers le nouveau planning
            fetch(`/move-appointment/${appointmentId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ newPlanning: newPlanning })
            })
                .then(response => {
                    if (response.ok) {
                        // Recharger la page après le déplacement du rendez-vous
                        window.location.reload();
                    } else {
                        console.error('Erreur lors du déplacement du rendez-vous');
                    }
                })
                .catch(error => console.error('Erreur réseau :', error));
        }
    }
</script>


</body>
</html>
